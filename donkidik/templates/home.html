<!doctype html>
<html ng-app="donkidik">
<head>
	<title>donkidik</title>
	<link rel="stylesheet" href="/static/semantic/dist/semantic.min.css">
	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/angularjs/1.3.1/angular.min.js"></script>
	<script type="text/javascript">
	angular.module('donkidik', [], function($httpProvider){
		// Use x-www-form-urlencoded Content-Type
		  $httpProvider.defaults.headers.post['Content-Type'] = 'application/x-www-form-urlencoded;charset=utf-8';

		  /**
		   * The workhorse; converts an object to x-www-form-urlencoded serialization.
		   * @param {Object} obj
		   * @return {String}
		   */ 
		  var param = function(obj) {
		    var query = '', name, value, fullSubName, subName, subValue, innerObj, i;

		    for(name in obj) {
		      value = obj[name];

		      if(value instanceof Array) {
		        for(i=0; i<value.length; ++i) {
		          subValue = value[i];
		          fullSubName = name + '[' + i + ']';
		          innerObj = {};
		          innerObj[fullSubName] = subValue;
		          query += param(innerObj) + '&';
		        }
		      }
		      else if(value instanceof Object) {
		        for(subName in value) {
		          subValue = value[subName];
		          fullSubName = name + '[' + subName + ']';
		          innerObj = {};
		          innerObj[fullSubName] = subValue;
		          query += param(innerObj) + '&';
		        }
		      }
		      else if(value !== undefined && value !== null)
		        query += encodeURIComponent(name) + '=' + encodeURIComponent(value) + '&';
		    }

		    return query.length ? query.substr(0, query.length - 1) : query;
		  };

		  // Override $http service's default transformRequest
		  $httpProvider.defaults.transformRequest = [function(data) {
		    return angular.isObject(data) && String(data) !== '[object File]' ? param(data) : data;
		  }];
		}).config(function($interpolateProvider){
			$interpolateProvider.startSymbol('[[');
			$interpolateProvider.endSymbol(']]');
		}).filter('html', ['$sce', function ($sce) { 
		    return function (text) {
		        return $sce.trustAsHtml(text);
		    };    
		}])
	</script>
	<style type="text/css">
		*{outline:none !important;}
		body{padding:0;margin:0;}
		#main{position: relative;width:550px;margin:0 auto;padding:50px 0;}
		#main > h1{text-align:center;}

		#main .post_creation {}
		#main .post_creation .post_types {}
		#main .post_creation .post_types ul {list-style: none; padding:0;}
		#main .post_creation .post_types ul li {display: inline;}
		#main .post_creation .post_types ul li .selected{background: darkgray;}
		#main .post_creation .post_inputs {}
		#main .post_creation .post_inputs .post_text {width: 50%; min-width: 300px}
		#main .post_creation .post_inputs .post_button_cont { margin-top: 10px; }


		#main #new_post_cont{position: relative;}
		#main #new_post_cont textarea{height:50px;min-height:0;line-height:auto;}
		#main #new_post_cont .sbmt{position: absolute;right:0;}
		#main #new_post_cont select{margin:5px 0;}
		#main .posts{position: relative;}
		#main .posts .loading{padding:150px;text-align:center;font-size:22px;}
		#main .posts > ul, #main .posts > ul > li{list-style:none;padding:0;margin:0;}
		#main .posts > ul > li{margin:25px 0;position: relative;padding:35px 25px;}
		#main .posts > ul > li.general{}
		#main .posts > ul > li.report{}
		#main .posts > ul > li .hdr{position: relative; padding-bottom: 5px;}
		#main .posts > ul > li .hdr .hdricon{font-size:23px;display: inline-block; position:relative; top:-8px; }
		#main .posts > ul > li .hdr .by{display: inline-block; position: relative;top:-4px;left:-5px;}
		#main .posts > ul > li .hdr .by .user_score{font-size: 10px; position:relative; top:-10px;padding:3px;}
		#main .posts > ul > li .hdr .by .time {font-size:10px;}
		#main .posts > ul > li .hdr .rank{position: absolute;top:15px;right:10px;width:50px;text-align:center;}
		#main .posts > ul > li .hdr .rank span{font-weight:bold;font-size:14px;}
		#main .posts > ul > li .hdr .rank i{position: absolute;left:50%;transform:translateX(-50%);-webkit-transform:translateX(-50%);-moz-transform:translateX(-50%);cursor:pointer;}
		#main .posts > ul > li .hdr .rank i.up{top:-11px;}
		#main .posts > ul > li .hdr .rank i.upvoted {color: green;}
		#main .posts > ul > li .hdr .rank i.down{bottom:-9px;}
		#main .posts > ul > li .hdr .rank i.downvoted {color:red;}
		#main .posts > ul > li .hdr .rank i.selected{color:#000;}
		#main .posts > ul > li .hdr .rank i.disabled{color:gray;}
		#main .posts > ul > li .content{}
		#main .posts > ul > li .comments{padding-top:10px;}
		#main .posts > ul > li .comments ul{list-style:none;padding:0;margin:0;}
		#main .posts > ul > li .comments ul li{list-style:none;margin:0;border-bottom:solid 1px #f1f1f1;padding:15px 0;}
		#main .posts > ul > li .comments ul li:last-of-type{border-bottom:none;}
		#main .posts > ul > li .comments ul li .label{}
		#main .posts > ul > li .comments ul li .comm_text{}
		#main .posts > ul > li .comments .add{}
		#main .posts > ul > li .comments .add .action.input{width:100%;}
		#main .posts > ul > li .comments .add .action.input input{width:100%;}
		#main .posts > ul > li .owner_actions{}
		#main .posts > ul > li .owner_actions button{float:right;}
	</style> 

	<script>

	// service
	(function(){

		var _is_success = function(response){
			return (response.data.status && response.data.status == 'OK');
		};

		angular.module('donkidik')
			.factory('homeService', function($http){
				return {
					get_posts: function(){
						var url = '/api/posts/all/';
						return $http.get(url).then(function(res){
							if (_is_success(res)) {
								return {
									success: true,
									posts: res.data.data
								};
							}
							else {
								return { success: false };
							}
						});
					},
					get_spots: function(){
						var url = '/api/spots/all/';
						return $http.get(url).then(function(res){
							if (_is_success(res)) {
								return {
									success: true,
									spots: res.data.data
								};
							}
							else {
								return { success: false };
							}
						});
					},
					reload_post_comments: function(pid) {
						var url = '/api/post/' + pid + '/comments/';
						return $http.get(url).then(function(res){
							if (_is_success(res)) {
								return {
									success:true,
									comments: res.data.comments 
								};
							}
							else {
								return { success: false };
							}
						});
					},
					post_comment: function(pid, text){
						var url = '/api/post/' + pid +'/add_comment/',
							params = { text: text };

						return $http.post(url, params).then(function(res){
							return {
								success: _is_success(res)
							};
						});
					},
					delete_post: function(pid){
						var url = '/api/post/remove/' + pid + '/';
						return $http.post(url).then(function(res){
							return {
								success: _is_success(res)
							};
						});
					},
					create_post: function(data){
						var url = '/api/post/add/';
						return $http.post(url, data).then(function(res){
							return {
								success: _is_success(res),
								post: res.data.post,
								error: res.data.error
							};
						});
					},
					post_upvote: function(pid){
						var url = '/api/post/'+pid+'/upvote/';
						return $http.post(url).then(function(res){
							return res.data;
						});
					},

					post_downvote: function(pid){
						var url = '/api/post/'+pid+'/downvote/';
						return $http.post(url).then(function(res){
							return res.data;
						});
					}
				};
			});

	})();
	
	// controller
	(function(){

		angular.module('donkidik')
			.controller('HomeController', function($scope, homeService){

				$scope.posts = [];
				$scope.spots = [];
				$scope.create_post_type = ''
				$scope.selected_post_type = 'general';
				$scope.new_post_error = '';

				$scope.get_range = function(min, max){
					var ret = [];
					for (var i=min; i<=max; i++)
						ret.push(i);
					return ret;
				};

				$scope.get_posts = function(){
					$scope.posts = [];
					homeService.get_posts().then(function(res){
						if (res.success) {
							$scope.posts = res.posts;
							$scope.posts_loaded = true;
						}
						else {
							//TODO: replace loading with error message
							alert('Error getting posts...');
						}
					});
				};


				$scope.get_spots = function(){
					$scope.spots = [];
					var err = false;
					homeService.get_spots().then(function(res){
						if (res.success) {
							if (res.spots){
								$scope.spots = res.spots;
							}
							else{
								err = true;
							}
						}
						else {
							err = true;
						}
						if (err){
							//TODO: tell user there was a problem reaching server
							alert("Error getting spots")
						}
					});
				};

				$scope.reload_post_comments = function(post) {
					homeService.reload_post_comments(post.post_id).then(function(res){
						if (res.success) {
							post.comments = res.comments;
						}
						else {
							alert('Error reloading post comments');
						}
					});
				};

				$scope.post_comment = function(post){
					if (!post.comm_text)
						return;

					var txt = post.comm_text;
					homeService.post_comment(post.post_id, txt).then(function(){
						$scope.reload_post_comments(post);
						post.comm_text = '';
					});
				};

				$scope.delete_post = function(post){
					
					if (!confirm('Sure?'))
						return;

					homeService.delete_post(post.post_id).then(function(res){
						if (res.success) {
							for (var i=0; i<$scope.posts.length; i++) {
								if ($scope.posts[i].post_id == post.post_id) {
									$scope.posts.splice(i, 1);
									break;
								}
							}
						}
						else {
							alert('Error deleting post');
						}
					});
				};

				// NEW
 				$scope.submit_new_post = function(){

 					$scope.new_post_error = '';
 					var post_type = $scope.selected_post_type,
 						text = $scope.new_post_text;

 					if (!text) {
 						$scope.new_post_error = 'Please enter your message';
 						return;
 					}

					var data = {
						post_type: (post_type == 'general' ? 1 : 2),
						text: text
					};

					if ($scope.selected_post_type == 'report') {
						var spot_id = ($scope.new_post_spot ? $scope.new_post_spot.id : false),
							knots = $scope.new_post_knots;
						if (!spot_id) {
							$scope.new_post_error = '<p>Please choose a Spot</p>';
						}
						if (!knots) {
							$scope.new_post_error += '<p>Please choose knots</p>';
						}
						if ($scope.new_post_error)
							return;
						
						data.spot_id = spot_id;
						data.knots = knots;
					}

					homeService.create_post(data).then(function(res){
						if (res.success) {
							$scope.new_post_text = '';
							$scope.new_post_error = '';
							$scope.new_post_knots = '';
							$scope.new_post_spot = '';
							$scope.posts.unshift(res.post);
						}
						else {
							$scope.new_post_error = 'Error saving post: ' + res.error || 'Internal error';
						}
					});

				};

				$scope.post_upvote = function(post,uid){
					homeService.post_upvote(post.post_id).then(function(res){
						if (res.status=='OK'){
							post.score += res.change_score;
							post.author.score = Math.max(post.author.score+res.change_score,0)
							if (res.change_score == -1){ // was previously upvoted. cancel the upvote
								post.is_upvoted = false;
								var i = post.upvotes.indexOf(res.uid);
								if (i >-1) post.upvotes.splice(i,1); //was already upvoted. cancel the previous upvote
								else alert('mismatch between post.upvotes and res.change_score');
								//TODO: remove else clause
							}
							else{ //increase score
								if (res.change_score > 1){
									var i = post.downvotes.indexOf(res.uid);
									if (i >-1){
										post.downvotes.splice(i,1); // delete previous downvote
										post.is_downvoted = false;
									}
									else alert('mismatch between post.downvotes and res.change_score');
									//TODO: remove else clause
								}
								post.upvotes.push(res.uid)
								post.is_upvoted = true;
							}
						}
						else{
							// TODO communicate this to UI
							if (res.error) alert(res.error);
							else alert("Service failed!");
						}
					});
				};

				$scope.post_downvote = function(post){
					homeService.post_downvote(post.post_id).then(function(res){
						if (res.status=='OK'){
							post.score += res.change_score;
							post.author.score = Math.max(post.author.score+res.change_score,0)
							if (res.change_score == 1){ // was previously downvoted. cancel the downvote
								post.is_downvoted = false;
								var i = post.downvotes.indexOf(res.uid);
								if (i >-1) post.downvotes.splice(i,1); //was already downvoted. cancel the previous downvote
								else alert('mismatch between post.downvotes and res.change_score');
								//TODO: remove else clause
							}
							else{ //reduced score
								if (res.change_score < -1){
									var i = post.upvotes.indexOf(res.uid);
									if (i >-1){
										post.upvotes.splice(i,1); // delete previous upvote
										post.is_upvoted = false;
									}
									else alert('mismatch between post.upotes and res.change_score');
									//TODO: remove else clause
								}
								post.downvotes.push(res.uid)
								post.is_downvoted = true;
							}
						}
						else{
							// TODO communicate this to UI
							if (res.error) alert(res.error);
							else alert("Service failed!");
						}
					});
				};
				$scope.get_spots();
				$scope.get_posts();

			});

	})();

	</script>
	<script type="text/javascript" src="static/angular/generalDirectives.js"></script>

</head>
<body>
	<div id="main" ng-controller="HomeController">
		<h1>DonkiDik</h1>
		
		<div class="ui raised segment" id="new_post_cont">
			<h4>Write a Post</h4>
			<div class="ui form">
				<div class="field">
			  		<textarea placeholder="Type a message..." ng-model="new_post_text"></textarea>
			  	</div>
			  	<div class="field" ng-show="selected_post_type == 'report'">
					<select ng-model="new_post_spot" class="spots" ng-options="spot as spot.name for spot in spots track by spot.id">
						<option value="" disabled selected style="display: none">Spot</option>
					</select>
					<select id="knots" ng-model="new_post_knots">
						<option value="" disabled selected style="display: none">Knots</option>
						<option ng-repeat="i in get_range(5, 34)" value="[[i]]">[[i]]</option>
					</select>					
			  	</div>
			  	<div class="field post_type">
					<div class="ui tiny buttons">
						<button class="ui button" ng-click="selected_post_type = 'general'" ng-class="{blue: selected_post_type == 'general'}">General Post</button>
						<button class="ui button" ng-click="selected_post_type = 'report'" ng-class="{blue: selected_post_type == 'report'}">Wind Report</button>
					</div>			  		
					<button class="ui tiny green button sbmt" ng-click="submit_new_post()" ng-disabled="!new_post_text">POST</button>
					<div class="ui message red" ng-show="new_post_error" ng-bind-html="new_post_error | html"></div>
			  	</div>
			</div>			
		</div>

		<div class="posts">
			<div class="loading" ng-show="!posts_loaded">
				Loading Posts...
			</div>
			<ul ng-show="posts_loaded">
				<post-dir ng-repeat="p in posts" data="[[p]]"></post-dir>
			</ul>
		</div>
	</div>
</body>
</html>





