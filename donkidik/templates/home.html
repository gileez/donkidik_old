{% extends "layout.html" %}

{% block head %}
	<style type="text/css">
		style{display:block !important;}
		#main input[type="text"], #main input[type="name"], #main input[type="password"]{margin:5px 0; padding: 5px;}

		#main {display:block; position: absolute;width:100%;}
		#main .add_post {padding: 20px 0; padding-bottom: 10px;}
		#main .add_post .types {color: black; background:none;}
		#main .add_post .types ul {list-style: none; padding:0; margin:0;}
		#main .add_post .types ul li {display:inline; padding: 5px;}
		#main .add_post .types ul li:hover {color:white; background: grey;}
		#main .add_post .types .selected, #main .add_post .types .selected:hover {color:white; background: black;}
		#main .add_post #post_state {color:red; font-size: 12px}
		#main .post_list, #main .add_post {width:33%; min-width: 300px; position:relative; left: 33.3%;}
		#main .post_list .post {border: solid 1px; font-size: 16px; margin-top:10px;}
		#main .post_list .post .user {display:inline-block;margin-left: 5px;}
		#main .post_list .post .timestamp {display:inline-block; float:right; margin-right: 5px;}
		#main .post_list .post .Report {background: teal; color:white;}
		#main .post_list .post .General {background: orange; color:white;}
		#main .post_list .post .text {display: block; margin: 5px;}
		#main .post_list .post a {color: white;}
		#main .post_list .post a:hover {color: teal; background: white;}
		
		.post {padding: 10px;}
		.post .user {font-weight: bold;}
		.post .post_text {padding: 10px;}
		.post .comment_text {padding: 5px;}
		.post .comment .user, .post .comment .comment_text {display: inline-block;}
		.post .actions {border-top: solid 1px; border-bottom: solid 1px; margin:0;padding:0;}
		.comment_container { margin: 5px; background-color:#f6f7f9;  font-size: 15px}
		.actions {}
		.glyphicon {font-size: 15px; padding: 5px 10px;}
		.glyphicon:hover {color:teal; background:black;}
	</style>
	
	<script id="post" type="text/x-jsrender">
		<div class="post" id="[[:post_id]]">
			<div class="[[:post_type]]">
				<div class="user">
					[[:post_type]] by <a href="user/[[:author.id]]/">[[:author.name]]</a>
				</div>
				<div class="timestamp">
					[[:date[0] ]]/[[:date[1] ]]/[[:date[2] ]]
				</div>
			</div>
			<div class="post_text">
				[[:text]]
			</div>
			<div class="actions">
  				<span class="glyphicon glyphicon-chevron-up" aria-hidden="true"></span>
  				<span class="glyphicon glyphicon-chevron-down" aria-hidden="true"></span>
			</div>
			[[if comments.length!=0]]
				<div class="comment_container">
				[[for comments]]
					<div class="comment">
						<div class="user" id="[[:user_id]]">
							[[:user]]
						</div>
						<div class="comment_text">
							[[:text]]
						</div>
					</div>
				[[/for]]
				</div>
			[[/if]]
			<div class="new_comment">
				<input type="text" class="form-control new_comment_text" placeholder="Comment..." />
				<input type="button" class="btn btn-default submit_comment" value="Add"/>
			</div>
		</div>
	</script>
	<script id="select" type="text/x-jsrender">
		<option vlue="[[:id]]">[[:name]]</option>
	</script>

	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jsrender/0.9.78/jsrender.min.js"></script>
	<script type="text/javascript">
		$(document).ready(function(){
			$.views.settings.delimiters("[[","]]");
			//get all posts
			var selected_id = 1;
			function refresh_posts(){
				$.post("api/posts/all/", function(res){
					var postTemplate = $.templates("#post");
					var $post_list = $(".post_list");
					var pl_html = postTemplate.render(res.data);
					// for (var i=res.data.length-1; i>-1; i--){
					// 	pl_html+="<div class=\"post\"><div class=\"" + res.data[i].post_type + "\">" + res.data[i].post_type +" by <a href=\"api/posts/" + res.data[i].id + "/\">"+ res.data[i].author.name + "</a></div><div class=\"text\">" + res.data[i].text + "</div></div>"
					// }
					$post_list.html(pl_html);
				});//end $.post
			}
			//get all post types
			$.post("api/post/types/",function(res){
				var $post_types = $(".types ul").first(),
					ptypes = '';
				for (var i=0; i<res.data.length ; i++){
					ptypes+="<li id=\""+ res.data[i].id + "\">"+ res.data[i].name + "</li>";
				}
				$post_types.html(ptypes);
				$(".types ul li").removeClass("selected"); 
				$(".types ul li").first().addClass("selected");

			});//end $.post
			//get all spots
			$.post("api/spots/get/",function(res){
				var $select = $(".spot select").first();
				var selectTemplate = $.templates("#select");
				var sel_html = selectTemplate.render(res.data);
				var empty_option = "<option disabled selected value> -- Spot -- </option>";
				$select.html(empty_option + sel_html);
			});
			//populate knots select
			var $knots_sel = $(".knots select");
			$knots_sel.html("<option disabled selected value> -- Knots -- </option>")
			for (i=1;i<=40;i++){
				$knots_sel.append($('<option></option>').val(i).html(i));
			}
			//listen to changes on selected post type
			$(document).on('click','.types ul li',function(){
				$(".types ul li").removeClass("selected");
				$(this).addClass("selected");
				var selected_id = $(this)[0].id;
				var selected_name = $(this).html();
				if (selected_name == 'General'){
					$('#post_text').show();
					$('.knots').hide();
					$('.spot').hide();
				}
				else if (selected_name == 'Report'){
					$('#post_text').show();
					$('.knots').show();
					$('.spot').show();
				}
				else {
					$('#post_text').hide();
					$('.knots').hide();
					$('.spot').hide();
				}
			});

			$("#submit_post").click(function(){
				var errors=[]
				var data={	'text': $("#post_text").val(),
						'post_type':selected_id,
						'type_name': $(".types .selected").html(),
						}
				if (data.type_name == 'Report'){
					var knots = $(".knots").find(":selected").val();
					var spot = $(".spot").find(":selected").val();
					if (knots == "") errors.push("Missing wind speed!");
					if (spot == "") errors.push("Missing spot!");
					if (errors.length == 0){
						data.knots = Number(knots);
						data.spot_name = spot;
					}

				}
				if (errors.length > 0){
					$('#post_state').html(errors.join("</br>"));
					return
				}
				$.post("api/post/add/", data, function(res){
					if (res.status == 'OK'){
						$("#post_text").val('');
						$("#post_state").empty();
					}
					else{
						//add error
						if (res.error){
							$("#post_state").html(res.error);
						}
						else{
							$("#post_state").html("unknown error when attempting to post");
						}
					}
				});//end $.post
				refresh_posts();
			});// end submit_post click
			
			$(document).on('click','.submit_comment',function(){
				//get pid
				var p = this.closest(".post");
				var pid = p.id;
				//get data
				var $text_input = $(p).find(".new_comment_text")[0];
				var text =$text_input.value;
				if (text==''){
					alert("can't comment with no text")
					return
				}
				var data = {'text': text};
				//alert(data,pid);
				$.post("api/post/"+pid+"/add_comment/", data, function(res){
					if (res.status == 'OK'){
						$text_input.value='';
						refresh_posts();
					}
				});//end $.post
			}); //end add_comment click
			refresh_posts();
		});//end documentready

	</script>
{% endblock %}
{% block body %}
	<div id="main">
		<div class="add_post">
			<div class="types">
				<ul></ul>
			</div>
			<div class="post_content">
				<input type="text" id="post_text" placeholder="let us know!" />
				<input type="button" class="btn btn-default" id="submit_post" value="post"/>
				<div class="spot">
					<select>
					</select>
				</div>
				<div class="knots">
					<select>
					</select>
				</div>
				<div id="post_state"></div>
			</div>
		</div>
		<div class="post_list">
		</div>
	</div>
{% endblock %}